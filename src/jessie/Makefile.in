FRAMAC_SHARE  = @FRAMAC_SHARE@
FRAMAC_LIBDIR = @FRAMAC_LIBDIR@

PLUGIN_NAME   = Jessie3
MODULES       = literals ACSLtoWhy3 register

WHYLIB  = ../../lib/why3

INCLUDE = -I $(FRAMAC_LIBDIR) -I $(FRAMAC_LIBDIR)/plugins -I +ocamlgraph @ZIPINCLUDE@ @MENHIRINCLUDE@ -I $(WHYLIB)
FLAGS = -w +a-3-4-6-9-41-44-45-48 -annot -bin-annot  -g
OCAMLLEX  = @OCAMLLEX@

all:: Jessie3.cma Jessie3.cmxs

Makefile: Makefile.in ../../config.status
	(cd ../../ ; ./config.status chmod --file src/jessie/Makefile)

literals.ml: literals.mll
	$(OCAMLLEX) $<

Jessie3.cma: $(addsuffix .cmo, $(MODULES))
	ocamlc.opt -a $(FLAGS) $(INCLUDE) -o $@ nums.cma unix.cma dynlink.cma str.cma $(addsuffix .cmo, @MENHIRLIB@) $(addsuffix .cma, @ZIPLIB@) $(WHYLIB)/why3.cma $^

Jessie3.cmx: $(addsuffix .cmx, $(MODULES))
	ocamlopt.opt $(FLAGS) $(INCLUDE) -o $@ -pack $^

Jessie3.cmxs: Jessie3.cmx
	ocamlopt.opt -shared $(FLAGS) $(INCLUDE) -o $@ $(addsuffix .cmx, @MENHIRLIB@) $(addsuffix .cmxa, @ZIPLIB@) $(WHYLIB)/why3.cmxa $^

%.cmo: %.ml
	ocamlc.opt $(FLAGS) $(INCLUDE) -c $^

%.cmx: %.ml
	ocamlopt.opt $(FLAGS) $(INCLUDE) -for-pack Jessie3 -c $^

test.byte:
	frama-c.byte -load-module ./Jessie3.cma -jessie3 tests/basic/forty-two.c
# -kernel-debug 2

test.opt:
	frama-c -load-module ./Jessie3.cmxs -jessie3 tests/basic/forty-two.c
# -kernel-debug 2

tests::
	time -p ptests.opt
	grep 'Task\|Ergo' tests/basic/result/*.res.log  tests/demo/result/*.res.log


clean:
	rm -f $(addsuffix .cmo, $(MODULES))
	rm -f $(addsuffix .cmx, $(MODULES))
	rm -f Jessie3.cma Jessie3.cmxs
