#!/bin/sh

print_info () {
  printf "usage: drv_depgraph <input-folder> [<output-folder>]\n"
  printf "  <input-folder> the folder containing .gen and .drv files\n"
  printf "  <output-folder> the folder in which files are going to be generated\n"
  printf "  if <output-folder> empty, files will be generated in the current directory\n"
}

if [ ! -d "$1" ] ; then
  print_info
  exit 2
else
  files="$(ls $1/*.drv $1/*.gen)"
fi

if test $# = 1; then
  outdir="./"
else if test $# = 2 && [ -d "$2" ] ; then
    outdir=$2
  else
    print_info
    exit 2
  fi
fi

# $1 = input file, $2 = output file
run_on_file () {
  file=`basename $1`
  echo "Calculating dependencies for $file"
  depends="$(sed -n -e 's/^import "\([^"]*\)"/\1/p' $1)"
  for d in $depends; do
    if test "$d" != "discrimination.gen" ; then
      echo "  \"$file\" -> \"$d\";" >> $2
    fi
  done
}

output="$outdir/all_drivers.dot"
echo "Graph will be generated in file $output"

echo "digraph G {" > "$output"
echo "  rankdir=RL;" >> "$output"
echo "  nodesep=0.4" >> "$output"
echo "  ranksep=0.6" >> "$output"
echo "  node [shape=box,margin=0.05]" >> "$output"

for file in $files; do
  run_on_file $file $output
done

echo "}" >> "$output"

echo "Graph generated in file $output"

output_connected="drivers"

echo "Generating connected components in different files"

ccomps "$output" -x -o "$outdir/$output_connected.dot"

# The following calculates the number of files generated by ccomps.
# Alternatively one could do the following:
#  'dotfiles="$(ls $outdir/$output_connected*.dot)"'
# However, for this to work properly all .dot files in the destination
# directory would need to be removed before each run - when the number
# of connected components drecreases from one run to the next one of
# the files won't be overwriten by the script and be captured by the
# command above.
connected_comps=$(ccomps -v -s "$output" 2>&1 | awk '{ if ($6 == "components") { print $5 } }')
echo "There are $connected_comps connected components."

i=1
dotfiles="$outdir/$output_connected.dot"
while [ $i -lt $connected_comps ] ; do
  dotfiles="$dotfiles $outdir/${output_connected}_$i.dot"
  i=$((i + 1))
done

echo "Converting to PDF"

pdffiles=""
for f in $dotfiles; do
  out="${f%.*}"
  dot "$f" -Tpdf -o "$out.pdf"
  pdffiles="$pdffiles $out"
done

echo "Generating tex file"

texfile="$outdir/drivers_dependency.tex"

figcount=1
figrefs=""

# $1 = input pdf file, $2 = output tex file, $3 = extra label
print_figure () {
  lbl="fig:drv:$figcount"
  if test "$figrefs" = "" ; then
    figrefs="\\\ref{$lbl}"
  else
    figrefs="$figrefs, \\\ref{$lbl}"
  fi
  echo "\\\begin{figure}" >> $2
  echo "  \\\begin{center}" >> $2
  echo "    \\\framebox{\\\includegraphics[scale=0.5]{$1}}" >> $2
  echo "  \\\end{center}" >> $2
  echo "  \\\caption{Drivers dependencies $figcount.}" >> $2
  echo "  \\\label{$lbl}" >> $2
  if test "$3" != "" ; then
      echo "  \\\label{$3}" >> $2
  fi
  echo "\\\end{figure}" >> $2
  echo "\n" >> $2
  figcount=$((figcount + 1))
}

echo "% File generated by drv_depgraph" > $texfile
echo "" >> $texfile

for f in $pdffiles; do
  label=""
  for x in "coq" "smt" "isabelle" "pvs" "tptp"; do
    if grep "$x" $f.dot -q ; then
      label="fig:drv:$x"
    fi
  done
  print_figure $(realpath $f.pdf) $texfile $label
done

echo "\\\newcommand{\\\driversref}{$figrefs}" >> $texfile

echo "LaTeX file generated in $texfile"
